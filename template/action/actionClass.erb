package cn.<%=@@projectName%>.web;

import java.util.List;
import net.sf.json.JSONArray;
import net.sf.json.JSONObject;
import java.util.ArrayList;
import org.hibernate.criterion.DetachedCriteria;
import org.springframework.beans.factory.annotation.Autowired;
import cn.<%=@@projectName%>.exception.BusinessException;
import cn.<%=@@projectName%>.framework.BaseAction;
import cn.<%=@@projectName%>.framework.PageFetch;
import cn.<%=@@projectName%>.model.<%=@@bean.table_name%>;
import cn.<%=@@projectName%>.service.<%=@@bean.table_name%>Service;

public class <%=@@bean.table_name%>Action extends BaseAction {

    private static final long serialVersionUID = 1L;
    @Autowired
    private <%=@@bean.table_name%>Service <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Service;
    private <%=@@bean.table_name%> <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>;
    private String <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Id;
    PageFetch<<%=@@bean.table_name%>> pf;

    public String get<%=@@bean.table_name%>Id() {
        return <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Id;
    }

    public void set<%=@@bean.table_name%>Id(String <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Id) {
        this.<%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Id = <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Id;
    }

    public PageFetch<<%=@@bean.table_name%>> getPf() {
        return pf;
    }

    public void setPf(PageFetch<<%=@@bean.table_name%>> pf) {
        this.pf = pf;
    }

    public <%=@@bean.table_name%> get<%=@@bean.table_name%>() {
        return <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>;
    }

    public void set<%=@@bean.table_name%>(<%=@@bean.table_name%> <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>) {
        this.<%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%> = <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>;
    }

    /**
     * 进入<%=@@bean.table_name%>的新增页面
     * 
     * @return String
     * @throws BusinessException
     */
    public String preAdd() {
        return SUCCESS;
    }

    /**
     * 新增<%=@@bean.table_name%>
     * 
     * @return String
     * @throws BusinessException
     */
    public String add() {
        try {
            <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Service.add<%=@@bean.table_name%>(<%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>);
            getJson().put("result", "success");
        } catch (BusinessException be) {
            getJson().put("result", "fail");
            return "fail";
        }
        return SUCCESS;
    }

    /**
     * 删除<%=@@bean.table_name%>
     * 
     * @return String
     * @throws BusinessException
     */  
    public String delete() {
        try {
            <%=@@bean.table_name%> <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%> = <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Service.find<%=@@bean.table_name%>ById(Long.parseLong(<%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Id));
            <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Service.delete<%=@@bean.table_name%>(<%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>);
            getJson().put("result", "success");
        } catch (BusinessException be) {
            getJson().put("result", "fail");
            return "fail";
        }
        return SUCCESS;
    }

    /**
     * 进入<%=@@bean.table_name%>的修改页面
     * 
     * @return String
     * @throws BusinessException
     */
    public String preUpdate() throws Exception {
        try {
            <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%> = <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Service.find<%=@@bean.table_name%>ById(Long.parseLong(<%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Id));
        } catch (BusinessException be) {
            return "fail";
        }
        return SUCCESS;
    }

    /**
     * 更新<%=@@bean.table_name%>
     * 
     * @return String
     * @throws BusinessException
     */
    public String update() {
        try {
            <%=@@bean.table_name%> <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%> = <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Service.find<%=@@bean.table_name%>ById(Long.parseLong(<%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Id));
            <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Service.update<%=@@bean.table_name%>(<%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>);
            getJson().put("result", "success");
        } catch (BusinessException be) {
            getJson().put("result", "fail");
            return "fail";
        }
        return SUCCESS;
    }

    /**
     * 查看<%=@@bean.table_name%>的详细信息
     * 
     * @return String
     * @throws BusinessException
     */
    public String view() throws Exception {
        try {
            <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%> = <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Service.find<%=@@bean.table_name%>ById(Long.parseLong(<%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Id));
        } catch (BusinessException be) {
            return "fail";
        }
        return SUCCESS;
    }

    /**
     * 展示所有符合条件的<%=@@bean.table_name%>
     * 
     * @return String
     * @throws BusinessException
     */
    public String list() {
        pf = getPageFetchFromRequest(request);
        DetachedCriteria dc = DetachedCriteria.forClass(<%=@@bean.table_name%>.class);       
        try {
            pf = <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Service.search<%=@@bean.table_name%>(dc, pf);
        } catch (BusinessException e) {
            return "fail";
        }        
        return SUCCESS;
    }

    /**
     * 异步的方式加载所有符合条件的<%=@@bean.table_name%>
     * 
     * @return String
     * @throws BusinessException
     */
    public String load() throws Exception {
        JSONObject json = new JSONObject();
        JSONArray jsonArr = new JSONArray();
        List<<%=@@bean.table_name%>> <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>List = null;
        DetachedCriteria dc = DetachedCriteria.forClass(<%=@@bean.table_name%>.class);
        pf = new PageFetch<<%=@@bean.table_name%>>(new ArrayList<<%=@@bean.table_name%>>(), 1);
        String page = request.getParameter("page");
        int pageInt = Integer.parseInt(page);
        <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%> = new <%=@@bean.table_name%>();
        pf.setStartIndex(pageInt*10-10+1);
        pf = <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Service.search<%=@@bean.table_name%>(dc, pf);
        <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>List = pf.getItems();
        for (<%=@@bean.table_name%> <%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>:<%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>List) {<% @@bean.columns.each do |p|%>
            json.put("<%=p.first%>",<%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>.get<%=p.first[0].upcase<<p.first[1,p.first.length]%>());<%end%> 
            jsonArr.add(json);
        }
        jsonArr.add(json);
        getJson().put("<%=@@bean.table_name[0].downcase<<@@bean.table_name[1,@@bean.table_name.length]%>Arr", jsonArr);
        getJson().put("total", pf.getTotalIndex());
        return SUCCESS;
    }
}
